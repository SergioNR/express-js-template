name: deploy :next docker container to koyeb

on:
    pull_request:
        branches: [ "next" ]

jobs:
    koyeb-deploy:
        runs-on: ubuntu-latest
        environment: dev
        concurrency: 
            group: "${{ github.ref_name }}"
            cancel-in-progress: true
        steps:
            - 
                name: Install and configure the Koyeb CLI
                uses: koyeb-community/koyeb-actions@v2
                with:
                    api_token: "${{ secrets.KOYEB_API_TOKEN }}"
            # - 
            #     name: Create DEV Brevo API key secret
            #     uses: koyeb/action-git-deploy/secret@v1
            #     with:
            #         secret-name: DEV_BREVO_API_KEY_SECRET
            #         secret-value: "${{ secrets.BREVO_API_KEY }}"
            # - 
            #     name: Create DEV Brevo API key secret
            #     uses: koyeb/action-git-deploy/secret@v1
            #     with:
            #         secret-name: DEV_BREVO_API_KEY_SECRET
            #         secret-value: "${{ secrets.BREVO_API_KEY }}"



            -
                name: Build and deploy the application to Koyeb
                uses: koyeb/action-git-deploy@v1
                with:
                    # service-env: "PORT=3000,BREVO_API_KEY=${{ secrets.BREVO_API_KEY }}, PINOJS_SOURCE_TOKEN=${{ secrets.PINOJS_SOURCE_TOKEN }}"
                    service-env: PORT=3000,NODE_ENV=production,BREVO_API_KEY=@DEV_BREVO_API_SECRET, 

                    service-instance-type: "eco-nano" #https://www.koyeb.com/docs/reference/instances
                    service-ports: "3000:http"
                    service-routes: "/:3000"
                    service-regions: "fra" # https://www.koyeb.com/docs/reference/regions
                    docker: "sergion14/expressjs-template:next"
                    docker-private-registry-secret: "SNR-Docker" # MANAGED in https://app.koyeb.com/settings/registry-configuration
                    docker-command: "./startLocal.sh"
                    skip-cache: true
